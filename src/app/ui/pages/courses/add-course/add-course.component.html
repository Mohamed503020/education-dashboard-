<div class="add-course" [dir]="languageService.direction">
  <div class="add-course__header">
    <div class="add-course__title-section">
      <h1 class="add-course__title">إضافة كورس جديد</h1>
      <nav class="add-course__breadcrumb">
        <a routerLink="/dashboard">لوحة التحكم</a>
        <span>/</span>
        <a routerLink="/courses/all">الكورسات</a>
        <span>/</span>
        <span>إضافة كورس</span>
      </nav>
    </div>
  </div>

  <div class="add-course__container">
    <!-- Section Tabs -->
    <div class="section-tabs">
      <button 
        class="section-tabs__tab"
        [class.section-tabs__tab--active]="activeSection() === 'info'"
        (click)="setActiveSection('info')"
        type="button"
      >
        <span class="material-icons">info</span>
        معلومات الكورس
      </button>
      <button 
        class="section-tabs__tab"
        [class.section-tabs__tab--active]="activeSection() === 'lessons'"
        (click)="setActiveSection('lessons')"
        type="button"
      >
        <span class="material-icons">menu_book</span>
        الدروس ({{ lessons.length }})
      </button>
      <button 
        class="section-tabs__tab"
        [class.section-tabs__tab--active]="activeSection() === 'videos'"
        (click)="setActiveSection('videos')"
        type="button"
      >
        <span class="material-icons">videocam</span>
        الفيديوهات ({{ videos.length }})
      </button>
      <button 
        class="section-tabs__tab"
        [class.section-tabs__tab--active]="activeSection() === 'pdfs'"
        (click)="setActiveSection('pdfs')"
        type="button"
      >
        <span class="material-icons">picture_as_pdf</span>
        ملفات PDF ({{ pdfs.length }})
      </button>
    </div>

    <form (ngSubmit)="onSubmit()" #courseForm="ngForm" novalidate>
      @if (errorMessage) {
        <div class="form-error" style="margin: 1rem 2rem;">
          <span class="material-icons">error</span>
          {{ errorMessage }}
        </div>
      }
      <!-- Course Info Section -->
      @if (activeSection() === 'info') {
        <div class="form-section">
          <h3 class="form-section__title">
            <span class="material-icons">info</span>
            المعلومات الأساسية
          </h3>
          <div class="form-grid">
            <div class="form-group form-group--wide">
              <label class="form-label" for="title">عنوان الكورس *</label>
              <input
                type="text"
                id="title"
                name="title"
                class="form-input"
                [(ngModel)]="course.title"
                required
                placeholder="مثال: أساسيات النحو العربي"
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="category">التصنيف *</label>
              <select
                id="category"
                name="category"
                class="form-input"
                [(ngModel)]="course.category"
                required
              >
                <option value="">اختر التصنيف</option>
                @for (cat of categories; track cat) {
                  <option [value]="cat">{{ cat }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="stage">المرحلة الدراسية</label>
              <select
                id="stage"
                name="stage"
                class="form-input"
                [(ngModel)]="course.stage"
                (ngModelChange)="onStageChange()"
              >
                <option value="">اختر المرحلة</option>
                @for (s of stages; track s.value) {
                  <option [value]="s.value">{{ s.label }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="grade">الصف الدراسي</label>
              <select
                id="grade"
                name="grade"
                class="form-input"
                [(ngModel)]="course.grade"
                [disabled]="!course.stage"
              >
                <option [ngValue]="null">اختر الصف</option>
                @for (g of gradesForStage; track g.value) {
                  <option [ngValue]="g.value">{{ g.label }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="level">المستوى *</label>
              <select
                id="level"
                name="level"
                class="form-input"
                [(ngModel)]="course.level"
                required
              >
                <option value="beginner">مبتدئ</option>
                <option value="intermediate">متوسط</option>
                <option value="advanced">متقدم</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="isFree">مجاني؟</label>
              <div class="toggle-group">
                <label class="toggle">
                  <input
                    type="checkbox"
                    id="isFree"
                    name="isFree"
                    [(ngModel)]="course.isFree"
                    (ngModelChange)="onFreeToggle()"
                  />
                  <span class="toggle__slider"></span>
                  <span class="toggle__label">{{ course.isFree ? 'مجاني' : 'مدفوع' }}</span>
                </label>
              </div>
            </div>
            @if (!course.isFree) {
              <div class="form-group">
                <label class="form-label" for="price">السعر (جنيه)</label>
                <input
                  type="number"
                  id="price"
                  name="price"
                  class="form-input"
                  [(ngModel)]="course.price"
                  min="0"
                  placeholder="0"
                />
              </div>
            }
            <div class="form-group">
              <label class="form-label" for="tags">الوسوم (مفصولة بفاصلة)</label>
              <input
                type="text"
                id="tags"
                name="tags"
                class="form-input"
                [(ngModel)]="course.tags"
                placeholder="مثال: نحو، صرف، بلاغة"
              />
            </div>
            <div class="form-group">
              <label class="form-label" for="status">حالة النشر</label>
              <select
                id="status"
                name="status"
                class="form-input"
                [(ngModel)]="course.status"
              >
                <option value="published">منشور</option>
                <option value="draft">مسودة</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="form-section__title">
            <span class="material-icons">description</span>
            تفاصيل الكورس
          </h3>
          <div class="form-grid">
            <div class="form-group form-group--full">
              <label class="form-label" for="shortDescription">وصف مختصر</label>
              <input
                type="text"
                id="shortDescription"
                name="shortDescription"
                class="form-input"
                [(ngModel)]="course.shortDescription"
                placeholder="وصف مختصر يظهر في بطاقة الكورس"
              />
            </div>
            <div class="form-group form-group--full">
              <label class="form-label" for="description">الوصف التفصيلي *</label>
              <textarea
                id="description"
                name="description"
                class="form-input form-input--textarea"
                [(ngModel)]="course.description"
                rows="4"
                required
                placeholder="اكتب وصفاً تفصيلياً للكورس..."
              ></textarea>
            </div>
          </div>
        </div>

      }

      <!-- Lessons Section -->
      @if (activeSection() === 'lessons') {
        <div class="form-section">
          <div class="form-section__header">
            <h3 class="form-section__title">
              <span class="material-icons">menu_book</span>
              دروس الكورس
            </h3>
            <button type="button" class="btn btn--primary btn--sm" (click)="addLesson()">
              <span class="material-icons">add</span>
              إضافة درس
            </button>
          </div>

          @if (lessons.length === 0) {
            <div class="empty-state">
              <span class="material-icons">library_books</span>
              <p>لم يتم إضافة دروس بعد</p>
              <button type="button" class="btn btn--outline" (click)="addLesson()">
                أضف الدرس الأول
              </button>
            </div>
          } @else {
            <div class="items-list">
              @for (lesson of lessons; track lesson.id) {
                <div class="item-card">
                  <div class="item-card__header">
                    <span class="item-card__icon item-card__icon--lesson">
                      <span class="material-icons">school</span>
                    </span>
                    <span class="item-card__label">الدرس {{ lesson.order }}</span>
                    <button type="button" class="item-card__remove" (click)="removeLesson(lesson.id)">
                      <span class="material-icons">close</span>
                    </button>
                  </div>
                  <div class="item-card__body">
                    <div class="form-group">
                      <label class="form-label">عنوان الدرس *</label>
                      <input
                        type="text"
                        class="form-input"
                        [(ngModel)]="lesson.title"
                        [name]="'lessonTitle' + lesson.id"
                        placeholder="أدخل عنوان الدرس"
                      />
                    </div>
                    <div class="form-group">
                      <label class="form-label">المدة</label>
                      <input
                        type="text"
                        class="form-input"
                        [(ngModel)]="lesson.duration"
                        [name]="'lessonDuration' + lesson.id"
                        placeholder="مثال: 45 دقيقة"
                      />
                    </div>
                    <div class="form-group form-group--full">
                      <label class="form-label">الوصف</label>
                      <textarea
                        class="form-input form-input--textarea"
                        [(ngModel)]="lesson.description"
                        [name]="'lessonDesc' + lesson.id"
                        rows="2"
                        placeholder="وصف مختصر للدرس"
                      ></textarea>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Videos Section -->
      @if (activeSection() === 'videos') {
        <div class="form-section">
          <div class="form-section__header">
            <h3 class="form-section__title">
              <span class="material-icons">videocam</span>
              فيديوهات الكورس
            </h3>
            <button type="button" class="btn btn--primary btn--sm" (click)="addVideo()">
              <span class="material-icons">add</span>
              إضافة فيديو
            </button>
          </div>

          @if (videos.length === 0) {
            <div class="empty-state">
              <span class="material-icons">video_library</span>
              <p>لم يتم إضافة فيديوهات بعد</p>
              <button type="button" class="btn btn--outline" (click)="addVideo()">
                أضف الفيديو الأول
              </button>
            </div>
          } @else {
            <div class="items-list">
              @for (video of videos; track video.id) {
                <div class="item-card">
                  <div class="item-card__header">
                    <span class="item-card__icon item-card__icon--video">
                      <span class="material-icons">play_circle</span>
                    </span>
                    <span class="item-card__label">فيديو {{ video.id }}</span>
                    <button type="button" class="item-card__remove" (click)="removeVideo(video.id)">
                      <span class="material-icons">close</span>
                    </button>
                  </div>
                  <div class="item-card__body">
                    <div class="form-group">
                      <label class="form-label">عنوان الفيديو *</label>
                      <input
                        type="text"
                        class="form-input"
                        [(ngModel)]="video.title"
                        [name]="'videoTitle' + video.id"
                        placeholder="أدخل عنوان الفيديو"
                      />
                    </div>
                    <div class="form-group">
                      <label class="form-label">رابط الفيديو *</label>
                      <input
                        type="url"
                        class="form-input"
                        [(ngModel)]="video.url"
                        [name]="'videoUrl' + video.id"
                        placeholder="https://youtube.com/watch?v=..."
                      />
                    </div>
                    <div class="form-group">
                      <label class="form-label">المدة</label>
                      <input
                        type="text"
                        class="form-input"
                        [(ngModel)]="video.duration"
                        [name]="'videoDuration' + video.id"
                        placeholder="مثال: 12:34"
                      />
                    </div>
                    <div class="form-group">
                      <label class="form-label">الدرس المرتبط</label>
                      <select
                        class="form-input"
                        [(ngModel)]="video.lessonId"
                        [name]="'videoLesson' + video.id"
                      >
                        <option [value]="0">-- بدون درس --</option>
                        @for (lesson of lessons; track lesson.id) {
                          <option [value]="lesson.id">{{ lesson.order }}. {{ lesson.title || 'درس بدون عنوان' }}</option>
                        }
                      </select>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- PDFs Section -->
      @if (activeSection() === 'pdfs') {
        <div class="form-section">
          <div class="form-section__header">
            <h3 class="form-section__title">
              <span class="material-icons">picture_as_pdf</span>
              ملفات PDF والموارد
            </h3>
            <button type="button" class="btn btn--primary btn--sm" (click)="addPdf()">
              <span class="material-icons">add</span>
              إضافة ملف
            </button>
          </div>

          @if (pdfs.length === 0) {
            <div class="empty-state">
              <span class="material-icons">description</span>
              <p>لم يتم إضافة ملفات بعد</p>
              <button type="button" class="btn btn--outline" (click)="addPdf()">
                أضف الملف الأول
              </button>
            </div>
          } @else {
            <div class="items-list">
              @for (pdf of pdfs; track pdf.id) {
                <div class="item-card">
                  <div class="item-card__header">
                    <span class="item-card__icon item-card__icon--pdf">
                      <span class="material-icons">picture_as_pdf</span>
                    </span>
                    <span class="item-card__label">ملف {{ pdf.id }}</span>
                    <button type="button" class="item-card__remove" (click)="removePdf(pdf.id)">
                      <span class="material-icons">close</span>
                    </button>
                  </div>
                  <div class="item-card__body">
                    <div class="form-group">
                      <label class="form-label">عنوان الملف *</label>
                      <input
                        type="text"
                        class="form-input"
                        [(ngModel)]="pdf.title"
                        [name]="'pdfTitle' + pdf.id"
                        placeholder="أدخل عنوان الملف"
                      />
                    </div>
                    <div class="form-group">
                      <label class="form-label">رفع ملف PDF *</label>
                      <div class="file-upload">
                        <input
                          type="file"
                          [id]="'pdfFile' + pdf.id"
                          accept=".pdf"
                          (change)="onFileSelect($event, pdf)"
                          class="file-upload__input"
                        />
                        <label [for]="'pdfFile' + pdf.id" class="file-upload__label">
                          <span class="material-icons">upload_file</span>
                          @if (pdf.fileName) {
                            <span>{{ pdf.fileName }}</span>
                          } @else {
                            <span>اختر ملف PDF</span>
                          }
                        </label>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="form-label">الدرس المرتبط</label>
                      <select
                        class="form-input"
                        [(ngModel)]="pdf.lessonId"
                        [name]="'pdfLesson' + pdf.id"
                      >
                        <option [value]="0">-- بدون درس --</option>
                        @for (lesson of lessons; track lesson.id) {
                          <option [value]="lesson.id">{{ lesson.order }}. {{ lesson.title || 'درس بدون عنوان' }}</option>
                        }
                      </select>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn--outline" (click)="onReset()" [disabled]="isSaving">
          <span class="material-icons">refresh</span>
          إعادة تعيين
        </button>
        <button type="submit" class="btn btn--primary" [disabled]="isSaving">
          @if (isSaving) {
            <span class="material-icons spinning">sync</span>
            {{ savingProgress || 'جاري الحفظ...' }}
          } @else {
            <span class="material-icons">save</span>
            حفظ الكورس
          }
        </button>
      </div>
    </form>
  </div>
</div>