@if (loading) {
  <div class="loading-state" dir="rtl">
    <div class="spinner"></div>
    <p>ุฌุงุฑู ุชุญููู ุงูุงูุชุญุงู...</p>
  </div>
} @else if (result) {
  <!-- Result Screen -->
  <div class="result-screen" dir="rtl">
    <div class="result-card" [class.passed]="result.passed" [class.failed]="!result.passed">
      <div class="result-icon">{{ result.passed ? '๐' : '๐' }}</div>
      <h1>{{ result.passed ? 'ูุจุฑูู! ูุฌุญุช ูู ุงูุงูุชุญุงู' : 'ููุฃุณูุ ูู ุชุฌุชุฒ ุงูุงูุชุญุงู' }}</h1>
      <div class="score-circle">
        <span class="score-num">{{ result.score }}%</span>
        <span class="score-label">ุงูุฏุฑุฌุฉ</span>
      </div>
      <div class="result-details">
        <div class="detail"><span>ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ</span><span>{{ result.earnedPoints }} / {{ result.totalPoints }}</span></div>
        <div class="detail"><span>ุฏุฑุฌุฉ ุงููุฌุงุญ</span><span>{{ exam?.passingScore }}%</span></div>
        <div class="detail"><span>ุงูุญุงูุฉ</span><span>{{ result.passed ? 'โ ูุงุฌุญ' : 'โ ุฑุงุณุจ' }}</span></div>
      </div>
      @if (result.passed) {
        <button class="btn btn-accent btn-lg" (click)="issueCertificate()" [disabled]="issuingCert">
          {{ issuingCert ? 'ุฌุงุฑู ุฅุตุฏุงุฑ ุงูุดูุงุฏุฉ...' : '๐ ุงุญุตู ุนูู ุงูุดูุงุฏุฉ' }}
        </button>
      } @else {
        <p class="retry-text">ููููู ุฅุนุงุฏุฉ ุงููุญุงููุฉ</p>
      }
      <a routerLink="/site" class="back-link">โ ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</a>
    </div>
  </div>
} @else if (exam && !attempt) {
  <!-- Start Screen -->
  <div class="start-screen" dir="rtl">
    <div class="start-card">
      <div class="start-icon">๐</div>
      <h1>{{ exam.title }}</h1>
      @if (exam.description) {
        <p class="start-desc">{{ exam.description }}</p>
      }
      <div class="exam-info">
        <div class="info-item"><span class="info-icon">๐</span><span>{{ exam.questions.length || 0 }} ุณุคุงู</span></div>
        <div class="info-item"><span class="info-icon">โฑ</span><span>{{ exam.timeLimit }} ุฏูููุฉ</span></div>
        <div class="info-item"><span class="info-icon">โ</span><span>ุฏุฑุฌุฉ ุงููุฌุงุญ: {{ exam.passingScore }}%</span></div>
        <div class="info-item"><span class="info-icon">๐</span><span>ูุญุงููุงุช ูุชุงุญุฉ: {{ exam.maxAttempts }}</span></div>
      </div>
      <div class="start-rules">
        <h3>ุชุนูููุงุช ุงูุงูุชุญุงู:</h3>
        <ul>
          <li>ูุฏูู {{ exam.timeLimit }} ุฏูููุฉ ูุฅููุงุก ุงูุงูุชุญุงู</li>
          <li>ุงุฎุชุฑ ุฅุฌุงุจุฉ ูุงุญุฏุฉ ููู ุณุคุงู</li>
          <li>ููููู ุงูุชููู ุจูู ุงูุฃุณุฆูุฉ ุจุญุฑูุฉ</li>
          <li>ุนูุฏ ุงูุชูุงุก ุงูููุช ูุชู ุชุณููู ุงูุงูุชุญุงู ุชููุงุฆูุงู</li>
          <li>ุชุญุชุงุฌ {{ exam.passingScore }}% ูููุฌุงุญ ูุงูุญุตูู ุนูู ุงูุดูุงุฏุฉ</li>
        </ul>
      </div>
      <button class="btn btn-accent btn-lg" (click)="startExam()">ุงุจุฏุฃ ุงูุงูุชุญุงู ุงูุขู</button>
    </div>
  </div>
} @else if (exam && attempt) {
  <!-- Exam in Progress -->
  <div class="exam-page" dir="rtl">
    <!-- Top Bar -->
    <div class="exam-topbar">
      <div class="container">
        <div class="topbar-content">
          <span class="exam-title">{{ exam.title }}</span>
          <div class="timer" [class.warning]="timeRemaining < 300">
            <span class="timer-icon">โฑ</span>
            <span>{{ formattedTime }}</span>
          </div>
          <div class="progress-info">
            {{ answeredCount }} / {{ totalQuestions }} ุณุคุงู
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="exam-layout">
        <!-- Question -->
        <div class="question-area">
          @if (exam.questions && exam.questions[currentQuestion]) {
            <div class="question-card">
              <div class="question-header">
                <span class="question-num">ุณุคุงู {{ currentQuestion + 1 }} ูู {{ totalQuestions }}</span>
              </div>
              <h2 class="question-text">{{ exam.questions[currentQuestion].text }}</h2>
              <div class="options-list">
                @for (option of exam.questions[currentQuestion].options; track $index) {
                  <button
                    class="option-btn"
                    [class.selected]="isSelected(currentQuestion, $index)"
                    (click)="selectAnswer(currentQuestion, $index)"
                  >
                    <span class="option-letter">{{ ['ุฃ', 'ุจ', 'ุฌ', 'ุฏ'][$index] || $index + 1 }}</span>
                    <span class="option-text">{{ option }}</span>
                  </button>
                }
              </div>
            </div>

            <div class="question-nav">
              <button class="nav-btn" (click)="prevQuestion()" [disabled]="currentQuestion === 0">โ ุงูุณุงุจู</button>
              @if (currentQuestion < totalQuestions - 1) {
                <button class="nav-btn primary" (click)="nextQuestion()">ุงูุชุงูู โ</button>
              } @else {
                <button class="nav-btn submit" (click)="submitExam()" [disabled]="submitting">
                  {{ submitting ? 'ุฌุงุฑู ุงูุชุณููู...' : 'ุชุณููู ุงูุงูุชุญุงู' }}
                </button>
              }
            </div>
          }
        </div>

        <!-- Navigator -->
        <div class="question-navigator">
          <h3>ุงูุฃุณุฆูุฉ</h3>
          <div class="nav-grid">
            @for (q of exam.questions; track $index) {
              <button
                class="nav-item"
                [class.active]="currentQuestion === $index"
                [class.answered]="answers.has($index)"
                (click)="goToQuestion($index)"
              >
                {{ $index + 1 }}
              </button>
            }
          </div>
          <div class="nav-legend">
            <span><span class="dot answered"></span> ุชู ุงูุฅุฌุงุจุฉ</span>
            <span><span class="dot active"></span> ุงูุญุงูู</span>
            <span><span class="dot"></span> ูู ููุฌุจ</span>
          </div>
          <button class="btn btn-submit-final" (click)="submitExam()" [disabled]="submitting">
            {{ submitting ? 'ุฌุงุฑู ุงูุชุณููู...' : 'ุชุณููู ุงูุงูุชุญุงู' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}
